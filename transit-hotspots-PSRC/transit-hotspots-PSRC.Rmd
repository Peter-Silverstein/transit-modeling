---
title: 'Transit Usage in Seattle: A Spatial Investigation'
author: "Peter Silverstein"
date: "`r Sys.Date()`"
output: 
  pdf_document:
      keep_tex: true
  fontsize: 12pt
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}\Huge\bfseries}
  - \posttitle{\par\end{center}}
  - \predate{\begin{center}\large}
  - \postdate{\par\end{center}}
  - \preauthor{\begin{center}\large}
  - \postauthor{\par\end{center}}
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \usepackage{rotating}
---
\begin{center}
    {\large Final Project}\\[0.5cm]
    {\large GIS and Spatial Analysis}\\[0.5cm]
    {\large QMSS5070}\\[0.5cm]
\end{center}

\newpage
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
# Loading Libraries
library(sf)
library(tmap)
library(tidyverse)
library(tidycensus)
library(here)
library(systemfonts)
library(forcats)
library(DBI)
library(RSQLite)

census_api_key("b04657cc5e7bc71a846e61ce45beb0b79b9f069f")

ACSlist <- load_variables(2022, "acs5", cache = TRUE)
```

# Introduction
## Research Question:

1. How does transit usage percentage (percent of trips using mass transit / total trips per census tract) vary spatially in and around Seattle and Tacoma, Washington? 
2. How does this variation relate to population density, median income, and median age at the census tract level?

## Purpose of Study:
There are essentially two purposes to this study. The first is to better understand where there are concentrations of high and low transit usage around the region. If there is clustering and we see hotspots and coldspots, further policy-focused questions can be asked. For example: given clustering, what characteristics of a census tract makes in more or less likely to be in one of these hot or cold zones? How might we allocate resources across hot zones, cold zones, and those in-between to increase the adoption of transit by commuters? Is the dispersion of transit availability closely related to the demand and does the dispersion favor certain demographic groups over others?

The second research question is a very basic attempt at answering one of these follow-up questions. By understanding how the three variables (population density, median income, and median age) are related to the outcome of interest (percentage of commuter trips taken using public transit), we can begin to fill in the knowledge gaps demonstrated by the questions above.

## Hypotheses

1. I believe we will see transit hotspots close to urban centers (e.g., Seattle and Tacoma, the two biggest cities in the region of interest). Further, I believe the opposite will be true for coldspots--they should exist further outside urban centers. These ideas are based on the fact that transit lines themselves tend to be clustered in high-density, urban areas, meaning opportunities for mass transit travel are more convenient and plentiful in more central urban areas.
2. I expect that transit use percentage is positively associated with population density and median income and negatively associated with age. I make this hypothesis about population density based on the reasoning above. I expect younger people to (a) be more likely to live in highly urban areas and (b) be less likely to own a personal vehicle (such as a car). Of the three variables, I am the least confident about median income, because I think the relationship could be pulled in both positive and negative directions. On one hand, urban areas tend to be more expensive and thus have a higher requirement for income to live there. On the other hand, lower income should be associated with lower rates of car ownership and thus lower income would be associated with higher transit ridership.

# Data and Methodology:

## Data Sources:

1. The **Puget Sound Regional Association (PSRC) Household Travel Survey (HTS) 2017-23** is a biennial survey of commuters done in the King, Kitsap, Pierce, and Snohomish counties of Washington state (the counties surrounding Seattle and Tacoma). The present analysis uses the Trips dataset from the HTS. Each observation in the dataset represents a single trip taken by a respondent and includes a variety of variables. Most important for my analysis are origin/destination tract and mode of travel, although the dataset also includes date, time, distance, speed, etc.
2. All **census tract-level ACS 2022 5-year estimates for demographic data and the associated geometries** were accessed via the R `tidycensus` package, which leverages an API connection to the US Census Bureau to provide US Census data for a specified geographic area.
3. Finally, **Stanford's Cities and Towns of the United States, 2014** dataset provided point data to allow me to add city labels to my maps for reference.

## Data Preparation/Spatial Data Management:

### Data Cleaning
The output from `tidycensus` is already quite clean, so the majority of data cleaning steps were conducted on the PSRC HTS dataset. After loading the dataset, I selected my columns of interest and converted their types where appropriate and useful (e.g., string to factor). The next step was to collapse the mode of travel column from around 50 unique responses (an artifact of (a) a very detailed survey and (b) some option changes over the years of the survey) to just 4 useful categories, outlined below:

1. *Mass Transit:* included in this category trips that used a metro bus, private bus or shuttle, urban rail/light rail, school bus, ferry, paratransit, and commuter rail. Essentially I included any multi-occupancy transit vehicle.
2. *Personal Vehicle:* trips including all single-occupancy motor vehicles. This includes personal cars, ride-shares, taxis, motorcycles, and car-share services.
3. *Active Transit:* included walking, running, biking, and skateboarding.
4. *Other:* included helicopter/plane, "other" responses.

I then implemented a number of filters to filter data that didn't pass muster for realism/were outside the scope of this question. This included the following operations:

1. Filtered non-complete survey responses
2. Filtered distance to the range of 0 to 150 miles
3. Filtered trip duration to only include those greater than 0 minutes
4. Filtered speed to exclude speeds greater than 150 mph
5. Filtered to remove observations with missing value for travel mode

### Spatial Joins
The next step was to count the number of trips and join these values to the geometries/ACS data from tidyverse. I used the `summarize()` function to count the number of total trips and number of trips per category for each census tracts. I then joined these counts to my geometry table via the `left_join()` function and matched on GEOID. Further, I removed any tracts from the analysis with 0 total trips. I acknowledge that this is a bit of a simplistic solution to missingness and will discuss it further in my analysis and conclusions. Finally, I calculated the percentage of trips in each tract that were made by mass transit mode (count of mass transit / count of total trips).

```{r include=FALSE}
# Loading PSRC Polygons and census data
psrc_polygons <- get_acs(state = "WA",
                    county = c("King", "Kitsap", "Pierce", "Snohomish"),
                          geography = "tract",
                          variables = c(medincome = "B19013_001",
                                        population = "B01003_001",
                                        medage = "B01002_001"),
                          geometry = TRUE,
                          keep_geo_vars = TRUE,
                          year = 2022,
                          output = "wide"
                          ) %>%
  filter(ALAND != 0) %>% # Filter tracts that are 100% water
  mutate(GEOID = as.double(GEOID))
psrc_polygons <- st_transform(psrc_polygons, crs = 26910)

# Loading my PSRC Household Survey Data
psrc_trips <- tibble(read.csv(here("geo-files","Household_Travel_Survey_Trips.csv")) %>%
  select("trip_id", "household_id", "person_id", "day_id", "travel_dow", 
         "svy_complete", "distance_miles", "duration_minutes", "speed_mph", 
         "origin_purpose", "dest_purpose", "mode_1", "travelers_total", 
         "survey_year", "trip_weight", "origin_tract10", "dest_tract10",
         "depart_time_hour","arrival_time_hour")) %>%
  mutate(mode_1 = as.factor(mode_1)) %>%
  mutate(dest_purpose = as.factor(dest_purpose)) %>%
  mutate(origin_purpose = as.factor(origin_purpose)) %>%
  mutate(travel_dow = as.factor(travel_dow)) %>%
  mutate(svy_complete = as.factor(svy_complete)) %>%
  mutate(travelers_total = as.factor(travelers_total)) %>%
  mutate(survey_year = as.factor(survey_year)) %>%
  # Collapsing the travel mode categories into 4 umbrella categories
  mutate(mode_collapsed = fct_collapse(mode_1, 
                    personalvehicle = c('Household vehicle 1',
                                        'Other non-household vehicle',
                                        'Car from work',
                                        'Household vehicle 3',
                                        'Household vehicle 2',
                                        'Other hired service (Uber, Lyft, or other smartphone-app car service)',
                                        "Friend/colleague's car",
                                        'Other vehicle in household',
                                        'Carshare service (e.g., Turo, Zipcar, ReachNow)',
                                        'Rental car',
                                        'Taxi (e.g., Yellow Cab)',
                                        'Household vehicle 4',
                                        'Other motorcycle/moped/scooter',
                                        'Household vehicle 6',
                                        'Other motorcycle/moped',
                                        'Household vehicle 5',
                                        'Household vehicle 7',
                                        'Household vehicle 8',
                                        'Personal scooter or moped (not shared)',
                                        'Carshare service (e.g., Turo, Zipcar, Getaround, GIG)',
                                        "Other motorcycle (not my household's)",
                                        'Other hired car service (e.g., black car, limo)',
                                        'Other motorcycle in household'),
                    masstransit = c('Bus (public transit)',
                                    'Private bus or shuttle',
                                    'Vanpool',
                                    'Urban Rail (e.g., Link light rail, monorail)',
                                    'School bus',
                                    'Ferry or water taxi',
                                    'Other rail (e.g., streetcar)',
                                    'Other bus (rMove only)',
                                    'Paratransit',
                                    'Commuter rail (Sounder, Amtrak)',
                                    'Urban Rail (e.g., Link light rail, monorail, streetcar)',
                                    'Other rail'),
                   activetransit = c('Bicycle or e-bike (rSurvey only)',
                                     'Walk (or jog/wheelchair)',
                                     'Skateboard or rollerblade',
                                     "Standard bicycle (my household's)",
                                     "Electric bicycle (my household's)",
                                     'Bike-share - electric bicycle',
                                     'Other rented bicycle',
                                     "Borrowed bicycle (e.g., a friend's)",
                                     'Bike-share - standard bicycle',
                                     'Bike-share bicycle (rMove only)',
                                     'Bicycle owned by my household (rMove only)',
                                     'Borrowed bicycle (e.g., from a friend) (rMove only)',
                                     'Other rented bicycle (rMove only)'),
                   other = c('Other mode (e.g., skateboard, kayak, motorhome, etc.)',
                             'Airplane or helicopter',
                             'Scooter or e-scooter (e.g., Lime, Bird, Razor)',
                             'Scooter-share (e.g., Bird, Lime)',
                             'Other scooter, moped, skateboard',
                             'Vehicle ferry (took vehicle on board)',
                             'Segway or Onewheel/electric unicycle'))) %>%
  # Filtering out fishy and irrelevant responses
  filter(svy_complete == "Complete") %>%
  filter(distance_miles <= 150) %>%
  filter(distance_miles > 0) %>%
  filter(duration_minutes > 0) %>%
  filter(speed_mph <= 150) %>%
  filter(mode_1 != "Missing Response")

# Departure count by tract
departure <- psrc_trips %>%
  group_by(origin_tract10) %>%
  summarize(departure_count = n()) %>%
  rename(GEOID = origin_tract10)

# Mass Transit trip count by departure tract
masstransit <- psrc_trips %>%
  filter(mode_collapsed == "masstransit") %>%
  group_by(dest_tract10) %>%
  summarize(masstransit_count = n()) %>%
  rename(GEOID = dest_tract10)

# Joining to the psrc_polygons table
psrc_table <- psrc_polygons %>%
  mutate(ALAND_miles = ALAND/2589988) %>% # Converting sq meters->sq miles
  mutate(pop_per_sqmile = populationE/ALAND_miles) %>%
  left_join(departure, by = "GEOID") %>%
  left_join(masstransit, by = "GEOID") %>%
  # Removing NA values in counts caused by an empty join
  mutate(
    departure_count = replace_na(departure_count, 0),
    masstransit_count = replace_na(masstransit_count, 0)
    ) %>%
  filter(departure_count > 0)
  
# Calculating mass transit percentage
psrc_table <- psrc_table %>%
  mutate(masstransit_perc = (masstransit_count / departure_count)*100) %>%
  mutate(masstransit_perc = replace_na(masstransit_perc, 0))

# Loading US cities and towns for labeling
cities <- st_as_sf(read_sf(dsn = here("geo-files",
                             "UScitiestowns",
                             "data_EPSG_4326",
                             "citiesx010g.shp"))) %>%
  filter(STATE == "WA") %>%
  filter(NAME == "Seattle" | NAME == "Tacoma")

cities <- st_transform(cities, crs = 26910)
```

## GIS Methodology Overview

### Manipulation/Analytical Methods Used
As mentioned above, I counted the number of trips inside each census tract, then converted the total trip and mass transit trip counts to percentage. Finally, I used a simple join function to associate the counts with their respective geometries.

For the analysis in this project, I will perform a global cluster analysis (using Moran's I) and visualize any hot and cold zones using Getis-Ord Gi*. These approaches should help me understand whether transit use is clustered and visualize where it is clustered. I will then run a Spatial Error Model (SEM) and a Spatial Lag Model (SLM) regressing mass transit percentage on population density, median income, and median age. I believe that the SEM is the better conceptual choice - I believe that it is likely that unmeasured factors (e.g., land use, transit quality/reliability, parking availability) are spatially correlated, while the idea that ridership in one tract influences another is a bit harder to intuit. That said, I will run both models in order to compare the results.

### Software Used
All data loading, cleaning, and manipulation, mapping (both choropleth and Getis-Ord Gi*), table-creation, regression modeling, and write-up were performed with R and R-Studio. 

# Results and Analysis

```{r echo=FALSE}
title <- "Mass Transit Trips as a % of Total Trips (classification = Jenks)"

# Creating callout lines and label positions for the cities
## Create callout line geometries (offset positions for labels)
sea_long <- cities$LONGITUDE[1]
sea_lat <- cities$LATITUDE[1]
sea_line_long <- sea_long - 0.6
sea_line_lat <- sea_lat + 0.2
sea_lab_long <- sea_line_long - 0.03
sea_lab_lat <- sea_line_lat + 0.04

tac_long <- cities$LONGITUDE[2]
tac_lat <- cities$LATITUDE[2]
tac_line_long <- tac_long - 0.4
tac_line_lat <- tac_lat - 0.2
tac_lab_long <- tac_line_long - 0.03
tac_lab_lat <- tac_line_lat - 0.02

callout_lines <- st_sfc(
  st_linestring(rbind(c(sea_long, sea_lat),
                      c(sea_line_long, sea_line_lat))), # Seattle
  st_linestring(rbind(c(tac_long, tac_lat),
                      c(tac_line_long, tac_line_lat))) # Tacoma
)

## Convert callout lines to sf object
callout_lines_sf <- st_sf(city = c("Seattle", "Tacoma"), 
                          geometry = callout_lines, crs = 4326)

## Create label positions (end of lines)
label_positions <- data.frame(
  city = c("Seattle", "Tacoma"),
  lon = c(sea_lab_long, tac_lab_long), # Label positions (end of lines)
  lat = c(sea_lab_lat, tac_lab_lat)
)

## Convert label positions to sf object
label_positions_sf <- st_as_sf(label_positions, 
                               coords = c("lon", "lat"), crs = 4326)

# Creating the map
masstransit_choropleth <- tm_shape(psrc_table, unit = "mi") +
  tm_polygons("masstransit_perc",
              style = "jenks",
              palette = c("white","#003903"),
              title = "Mass Transit %",
              border_col = "black",
              lwd = 0.2) +
  tm_scale_bar(breaks = c(0, 5, 10, 15, 20), 
               color.dark = "#003903",
               position = c("right","BOTTOM")) +
  tm_compass(size = 2, position = c("LEFT", "bottom")) +
  tm_layout(main.title = title, 
            main.title.size = 0.75,
            main.title.fontface = "italic",
            inner.margins = c(0.1,0.1,0.1,0.1),
            fontfamily = "serif",
            compass.type = "rose",
            legend.bg.color = "white",
            legend.frame = TRUE,
            legend.position = c("left","top"),
            legend.title.size = 1) +
  tm_shape(cities) + # Add dots for Seattle and Tacoma
  tm_dots(size = 0.1, 
          col = "red") +
  tm_shape(callout_lines_sf) +
  tm_lines(col = "black", 
           lwd = 1) + # Add call-out lines
  tm_shape(label_positions_sf) +
  tm_text("city", 
          size = 0.8, 
          col = "black", 
          fontface = "italic") # Add labels

masstransit_choropleth
```






























































